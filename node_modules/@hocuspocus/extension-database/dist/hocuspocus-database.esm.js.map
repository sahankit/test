{"version":3,"file":"hocuspocus-database.esm.js","sources":["../src/Database.ts"],"sourcesContent":["import {\n  Extension,\n  onChangePayload,\n  onLoadDocumentPayload,\n  storePayload,\n  fetchPayload,\n} from '@hocuspocus/server'\nimport * as Y from 'yjs'\n\nexport interface DatabaseConfiguration {\n  /**\n   * Pass a Promise to retrieve updates from your database. The Promise should resolve to\n   * an array of items with Y.js-compatible binary data.\n   */\n  fetch: (data: fetchPayload) => Promise<Uint8Array | null>,\n  /**\n   * Pass a function to store updates in your database.\n   */\n  store: (data: storePayload) => void,\n}\n\nexport class Database implements Extension {\n  /**\n   * Default configuration\n   */\n  configuration: DatabaseConfiguration = {\n    fetch: async () => null,\n    store: async () => null,\n  }\n\n  /**\n   * Constructor\n   */\n  constructor(configuration: Partial<DatabaseConfiguration>) {\n    this.configuration = {\n      ...this.configuration,\n      ...configuration,\n    }\n  }\n\n  /**\n   * Get stored data from the database.\n   */\n  async onLoadDocument(data: onLoadDocumentPayload): Promise<any> {\n    const update = await this.configuration.fetch(data)\n\n    if (update) {\n      Y.applyUpdate(data.document, update)\n    }\n\n    return data.document\n  }\n\n  /**\n   * Store new updates in the database.\n   */\n  async onStoreDocument(data: onChangePayload) {\n    return this.configuration.store({\n      ...data,\n      state: Buffer.from(\n        Y.encodeStateAsUpdate(data.document),\n      ),\n    })\n  }\n}\n"],"names":[],"mappings":";;MAqBa,QAAQ,CAAA;AASnB;;AAEG;AACH,IAAA,WAAA,CAAY,aAA6C,EAAA;AAXzD;;AAEG;AACH,QAAA,IAAA,CAAA,aAAa,GAA0B;AACrC,YAAA,KAAK,EAAE,YAAY,IAAI;AACvB,YAAA,KAAK,EAAE,YAAY,IAAI;SACxB,CAAA;QAMC,IAAI,CAAC,aAAa,GAAG;YACnB,GAAG,IAAI,CAAC,aAAa;AACrB,YAAA,GAAG,aAAa;SACjB,CAAA;KACF;AAED;;AAEG;IACH,MAAM,cAAc,CAAC,IAA2B,EAAA;QAC9C,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,IAAI,CAAC,CAAA;AAEnD,QAAA,IAAI,MAAM,EAAE;YACV,CAAC,CAAC,WAAW,CAAC,IAAI,CAAC,QAAQ,EAAE,MAAM,CAAC,CAAA;AACrC,SAAA;QAED,OAAO,IAAI,CAAC,QAAQ,CAAA;KACrB;AAED;;AAEG;IACH,MAAM,eAAe,CAAC,IAAqB,EAAA;AACzC,QAAA,OAAO,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC;AAC9B,YAAA,GAAG,IAAI;AACP,YAAA,KAAK,EAAE,MAAM,CAAC,IAAI,CAChB,CAAC,CAAC,mBAAmB,CAAC,IAAI,CAAC,QAAQ,CAAC,CACrC;AACF,SAAA,CAAC,CAAA;KACH;AACF;;;;"}